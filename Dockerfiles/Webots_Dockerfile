# Use an official ROS2 Humble image as the base, based on Ubuntu 22.04
FROM osrf/ros:humble-desktop

ENV USER=webots
# Set non-interactive frontend to avoid prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install necessary packages
RUN apt-get update && apt-get install -y \
    wget lsb-release gnupg curl \
    python3-colcon-common-extensions \
    python3-vcstool

# Download and install Webots R2025a
RUN apt-get update && \
    wget https://github.com/cyberbotics/webots/releases/download/R2025a/webots_2025a_amd64.deb && \
    apt-get install -y ./webots_2025a_amd64.deb && \
    rm ./webots_2025a_amd64.deb && \
    rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y \
    ros-humble-webots-ros2 \
    ros-humble-webots-ros2-tests \
    ros-humble-navigation2 \
    ros-humble-nav2-bringup \
    ros-humble-moveit \
    ros-humble-moveit-ros-move-group \
    ros-humble-moveit-kinematics \
    ros-humble-moveit-planners \
    ros-humble-moveit-simple-controller-manager \
    ros-humble-moveit-ros-visualization \
    ros-humble-moveit-ros-warehouse \
    ros-humble-moveit-setup-assistant \
    ros-humble-moveit-configs-utils \
    ros-humble-ros2-control \
    ros-humble-controller-manager \
    ros-humble-joint-state-broadcaster \
    ros-humble-joint-state-publisher \
    ros-humble-joint-state-publisher-gui \
    ros-humble-pointcloud-to-laserscan \
    ros-humble-xacro \
    ros-humble-rmw-zenoh-cpp \
 && rm -rf /var/lib/apt/lists/*

# Set Webots environment variables
ENV WEBOTS_HOME=/usr/local/webots
ENV QT_QPA_PLATFORM_PLUGIN_PATH=$WEBOTS_HOME/lib/webots/qt/plugins
ENV LD_LIBRARY_PATH=$WEBOTS_HOME/lib/controller:$LD_LIBRARY_PATH

# Copy the repository
COPY colcon_ws/src/webots_ros2_spot /colcon_ws/src/webots_ros2_spot

# Copy world files into the workspace
# COPY modified_files/spot_driver.py /colcon_ws/src/webots_ros2_spot/webots_spot/spot_driver.py
COPY webots_files/world_files/*.wbt /colcon_ws/src/webots_ros2_spot/worlds/
COPY webots_files/launch_files/*_launch.py /colcon_ws/src/webots_ros2_spot/launch/
# COPY maps/wzl_2.wbt /colcon_ws/src/webots_ros2_spot/worlds/wzl.wbt


# Fix MAP BUG
COPY webots_files/config_files/spot_driver_.py /colcon_ws/src/webots_ros2_spot/webots_spot/spot_driver.py
# COPY webots_files/config_files/my_VelodynePuck.proto /colcon_ws/src/webots_ros2_spot/protos/my_VelodynePuck.proto

# #Uncomment to use map
# COPY modified_files/wzl_map.pgm /colcon_ws/src/webots_ros2_spot/map/wzl_map.pgm
# COPY modified_files/wzl_map.yaml /colcon_ws/src/webots_ros2_spot/map/wzl_map.yaml

# Install ROS2 dependencies and additional repositories
WORKDIR /colcon_ws

# First bring in all repos
RUN vcs import --recursive src --skip-existing --input src/webots_ros2_spot/webots_ros2_spot.repos

# Then resolve and install dependencies
RUN rosdep update && \
    rosdep install --ignore-src --from-paths src -y -r

# Make the supervisor script executable
RUN chmod +x src/webots_ros2/webots_ros2_driver/webots_ros2_driver/ros2_supervisor.py

# Build the workspace
RUN /bin/bash -c "source /opt/ros/humble/setup.bash && colcon build --symlink-install"

# Copy overlay workspace and install dependencies
# COPY overlay_ws/src/ /overlay_ws/src/
# WORKDIR /overlay_ws/
# RUN apt-get update && rosdep update && \
#     rosdep install --from-paths src --ignore-src -r -y && rm -rf /var/lib/apt/lists/*

# # Source and build overlay_ws
# RUN /bin/bash -c "source /colcon_ws/install/setup.bash && colcon build --symlink-install"

# Add workspace setup to bashrc
RUN echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc && \
    echo "source /colcon_ws/install/setup.bash" >> ~/.bashrc
    # echo "source /overlay_ws/install/setup.bash" >> ~/.bashrc

# Runtime env (set as ENV so non-interactive shells see them)
ENV RMW_IMPLEMENTATION=rmw_zenoh_cpp \
    ROS_DOMAIN_ID=22

# Optional: helpful entry scripts
# COPY entrypoint_scripts/webots_entry.sh /webots_entry.sh
# RUN chmod +x /webots_entry.sh

# Set the default command
CMD ["bash"]
